웹서버와 WAS(Web Application Server)는 다르다.  
기본적으로 정적인 부분은 웹서버에서 처리한다. 그렇지 않으면 Was 서버가 Web서버의 역할까지 수행하면서 이미지, Css,Js,Html처리에  
Was 서버의 스레드를 점유하게 된다.

구조는 웹서버 -> WAS로 운영한다.

아파치 웹서버에서 성능에 영향으 주는 설정을 나열한다.  

아파치 웹 서버는 **MPM(Muilt-Processing Module)**로 여러 개의 프로세싱 모듈 기반의 서비스를 제공한다.

conf/httpd.conf 에서 파일을 수정할 수 있다.

웹 서버의 스레드 개수를 수정한다던가 

```{.java}
ThreadsPerChild 250
// 프로세스 하나당 250개의 스레드가 만들어진다. 수치를 늘리면 더 많은 사용자의 요청을 처리할 수 있다.
```

최대 요청 개수를 지정 할 수 있다.
```{.java}
MaxRequestsPerChild 0
// 최대 요청 개수를 지정하는 부분 (0 제한 두지 않음)
```

* StartServers : 서버를 띄울 때 프로세스의 개수를 지정 (child 프로세스의 개수를 이야기한다.)
* MaxClients : 최대 처리 가능한 클라이언트 수를 지정한다.
* MinSpareThreads : 최소 여유 스레드 수를 지정한다.
* MaxSpareThreads : 최대 여유 스레드 수를 지정한다.
* ThreadsPerChild : 프로세스당 스레드 수를 지정한다.

```{.java}
  StartServers  2
  MaxClients 150
  MinSpareThreads 25 
  MaxSpareThreads 75
  ThreadsPerChild 25
// 프로세스 2개 스레드당 20~75명 최대 사용 가능한 클라이언트 수 150이 됩니다.(MaxClient에도 150)
```
####이용자가 150명 이상이거나 WAS가 멈추면 어떤 상황으로 진행이 될까?
1초당 150명의 요청을 받고 있다고 가정하에 웹 서버에서 150명의 요청을 받고, WAS도 150의 요청을 받는다.
자바는 GC할 때 JVM 자체가 멈춘다. 이 GC가 2초가 걸리면 아파치 웹서버는 300명의 요청을 기다리게 될 것이고.  
GC동안 WAS가 멈추기 때문에 새로운 연결을 할 수 없다.

이 경우 Tomcat에서 AJP Connector이라는 웹서버와 WAS 사이 커넥터에 설정한 backLog라는 값이 영향을 받는다.
이 경우 설정값에 따라 요청을 큐에 담아 두는데 요청이 큐를 넘게 되면 503 에러코드를 뿌린다.

실제로 대용량 이벤트에 자주 있는 일이며 충분히 확인이 필요하다.

**해결방안**
1. 서버를 늘린다 : 가장 단순한 방법. 금전적으로 여유가 있다면 가능하다.
2. 서비스를 튜닝한다 : 서비스가 응답이 안 되는 원인을 찾는다. (현 제니퍼로 확인) 원인을 찾는 데 해당 트래픽이 나오지 않으면 찾기 어렵다.
3. GC 튜닝 : GC가 오래 소요되서 응이 안될 수 있다.
4. 옵션 값을 튜닝 : was 전문가, 엔지니어와 협의

현 서버를 늘려 트래픽 분산으로 해결을 했었다. 동시에 제니퍼를 사용하여 응답이 늦거나, GC 상황 확인 후 튜닝에 들어간다.

웹 서버의 Keep Alive
---
웹 서버와 웹 브라우저가 연결이 되었을 때 KeepAlive 기능이 꺼져있으면 매번 HTTP 연결을 맺었다 끊었다 한다.  
즉 연결 될 때마다 이미지, CSS, JS파일 등 연결 될 때 마다 받는다.  
KeepAlive가 켜저있으면 연결을 계속 사용한다. 

KeepAlive는 TimeOut 설정하여 사용자가 많아 접속이 안될 경우 5초정도로 짧게 하요 서버 리소스 효율적으로 사용한다.
> 사용자의 접근이 많은 사이트에서는 이미지,CSS등 정적인 파일을 CDN(Content Delivery Network ex) s3)를 사용  
별도 URL에 해당 컨텐츠 내려 받고, 동적 컨턴츠는 Was에 처리하면 서버 부담도 줄어든다.    

